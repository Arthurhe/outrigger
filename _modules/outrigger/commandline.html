<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>outrigger.commandline &#8212; Outrigger 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="Outrigger 1.0.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for outrigger.commandline</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">gffutils</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">outrigger</span> <span class="k">import</span> <span class="n">__version__</span>
<span class="kn">import</span> <span class="nn">outrigger.common</span>
<span class="kn">from</span> <span class="nn">outrigger</span> <span class="k">import</span> <span class="n">util</span><span class="p">,</span> <span class="n">common</span>
<span class="kn">from</span> <span class="nn">outrigger.index</span> <span class="k">import</span> <span class="n">events</span><span class="p">,</span> <span class="n">adjacencies</span>
<span class="kn">from</span> <span class="nn">outrigger.io</span> <span class="k">import</span> <span class="n">star</span><span class="p">,</span> <span class="n">gtf</span><span class="p">,</span> <span class="n">bam</span>
<span class="kn">from</span> <span class="nn">outrigger.psi</span> <span class="k">import</span> <span class="n">compute</span>
<span class="kn">from</span> <span class="nn">outrigger.validate</span> <span class="k">import</span> <span class="n">check_splice_sites</span>


<span class="n">OUTPUT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;outrigger_output&#39;</span><span class="p">)</span>
<span class="n">JUNCTION_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT</span><span class="p">,</span> <span class="s1">&#39;junctions&#39;</span><span class="p">)</span>
<span class="n">JUNCTION_READS_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">JUNCTION_PATH</span><span class="p">,</span> <span class="s1">&#39;reads.csv&#39;</span><span class="p">)</span>
<span class="n">JUNCTION_METADATA_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">JUNCTION_PATH</span><span class="p">,</span> <span class="s1">&#39;metadata.csv&#39;</span><span class="p">)</span>
<span class="n">INDEX</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="n">EVENTS_CSV</span> <span class="o">=</span> <span class="s1">&#39;events.csv&#39;</span>
<span class="n">METADATA_CSV</span> <span class="o">=</span> <span class="s1">&#39;metadata.csv&#39;</span>


<div class="viewcode-block" id="CommandLine"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.CommandLine">[docs]</a><span class="k">class</span> <span class="nc">CommandLine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;outrigger (</span><span class="si">{version}</span><span class="s1">). Calculate &quot;percent-spliced in&quot;&#39;</span>
                        <span class="s1">&#39; (Psi) scores of alternative splicing on a *de novo*,&#39;</span>
                        <span class="s1">&#39; custom-built splicing index -- &#39;</span>
                        <span class="s1">&#39;just for you!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--version&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;version&#39;</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="s1">&#39;outrigger </span><span class="si">{version}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subparser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Sub-commands&#39;</span><span class="p">)</span>

        <span class="c1"># --- Subcommand to build the index of splicing events --- #</span>
        <span class="n">index_parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subparser</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
            <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Build an index of splicing events using a graph &#39;</span>
                          <span class="s1">&#39;database on your junction reads and an annotation&#39;</span><span class="p">)</span>

        <span class="n">index_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">OUTPUT</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of the folder where you saved the output from &#39;</span>
                 <span class="s1">&#39;&quot;outrigger index&quot; (default is </span><span class="si">{}</span><span class="s1">, which is &#39;</span>
                 <span class="s1">&#39;relative to the directory where you called the program)&quot;. &#39;</span>
                 <span class="s1">&#39;You will need this file for the next step, &quot;outrigger psi&quot;&#39;</span>
                 <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">OUTPUT</span><span class="p">))</span>

        <span class="n">index_junctions</span> <span class="o">=</span> <span class="n">index_parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">index_junctions</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-j&#39;</span><span class="p">,</span> <span class="s1">&#39;--sj-out-tab&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;SJ.out.tab files from STAR aligner output. Not &#39;</span>
                            <span class="s1">&#39;required if you specify &#39;</span>
                            <span class="s1">&#39;&quot;--compiled-junction-reads&quot;&#39;</span><span class="p">)</span>
        <span class="n">index_junctions</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--junction-reads-csv&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of the splice junction files to detect novel exons and &quot;</span>
                 <span class="s2">&quot;build an index of alternative splicing events from. &quot;</span>
                 <span class="s2">&quot;Not required if you specify &quot;</span>
                 <span class="s2">&quot;SJ.out.tab file with &#39;--sj-out-tab&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">sj_csv</span><span class="o">=</span><span class="n">JUNCTION_READS_PATH</span><span class="p">))</span>
        <span class="n">index_junctions</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;--bam&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Location of bam files to use for finding events.&quot;</span><span class="p">)</span>
        <span class="n">index_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;--min-reads&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                  <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                                  <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minimum number of reads per junction &#39;</span>
                                       <span class="s1">&#39;for that junction to count in creating&#39;</span>
                                       <span class="s1">&#39; the index of splicing events &#39;</span>
                                       <span class="s1">&#39;(default=10)&#39;</span><span class="p">)</span>
        <span class="n">index_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ignore-multimapping&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                                  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Applies to STAR SJ.out.tab files only.&#39;</span>
                                       <span class="s1">&#39; If this flag is used, then do not &#39;</span>
                                       <span class="s1">&#39;include reads that mapped to multiple &#39;</span>
                                       <span class="s1">&#39;locations in the genome, not uniquely &#39;</span>
                                       <span class="s1">&#39;to a locus, in the read count for a &#39;</span>
                                       <span class="s1">&#39;junction. If inputting &quot;bam&quot; files, &#39;</span>
                                       <span class="s1">&#39;then this means that reads with a &#39;</span>
                                       <span class="s1">&#39;mapping quality (MAPQ) of less than &#39;</span>
                                       <span class="s1">&#39;255 are considered &quot;multimapped.&quot; This&#39;</span>
                                       <span class="s1">&#39; is the same thing as what the STAR &#39;</span>
                                       <span class="s1">&#39;aligner does. By default, this is off,&#39;</span>
                                       <span class="s1">&#39; and all reads are used.&#39;</span><span class="p">)</span>
        <span class="n">index_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;--max-de-novo-exon-length&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">outrigger</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">MAX_DE_NOVO_EXON_LENGTH</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Maximum length of an exon detected &#39;</span>
                 <span class="s1">&#39;*de novo* from the dataset. This is to&#39;</span>
                 <span class="s1">&#39; prevent multiple kilobase long exons &#39;</span>
                 <span class="s1">&#39;from being accidentally created. &#39;</span>
                 <span class="s1">&#39;(default=</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">outrigger</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">MAX_DE_NOVO_EXON_LENGTH</span><span class="p">))</span>

        <span class="n">gtf_parser</span> <span class="o">=</span> <span class="n">index_parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">gtf_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">,</span> <span class="s1">&#39;--gtf-filename&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of the gtf file you want to use. If&quot;</span>
                                     <span class="s2">&quot; a gffutils feature database doesn&#39;t &quot;</span>
                                     <span class="s2">&quot;already exist at this location plus &quot;</span>
                                     <span class="s2">&quot;&#39;.db&#39; (e.g. if your gtf is gencode.v19.&quot;</span>
                                     <span class="s2">&quot;annotation.gtf, then the database is &quot;</span>
                                     <span class="s2">&quot;inferred to be gencode.v19.annotation.&quot;</span>
                                     <span class="s2">&quot;gtf.db), then a database will be auto-&quot;</span>
                                     <span class="s2">&quot;created. Not required if you provide a &quot;</span>
                                     <span class="s2">&quot;pre-built database with &quot;</span>
                                     <span class="s2">&quot;&#39;--gffutils-db&#39;&quot;</span><span class="p">)</span>
        <span class="n">gtf_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--gffutils-db&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of the gffutils database file you &quot;</span>
                                     <span class="s2">&quot;want to use. The exon IDs defined here &quot;</span>
                                     <span class="s2">&quot;will be used in the function when &quot;</span>
                                     <span class="s2">&quot;creating splicing event names. Not &quot;</span>
                                     <span class="s2">&quot;required if you provide a gtf file with&quot;</span>
                                     <span class="s2">&quot; &#39;--gtf-filename&#39;&quot;</span><span class="p">)</span>
        <span class="n">index_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                                  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If given, print debugging logging &#39;</span>
                                       <span class="s1">&#39;information to standard out (Warning:&#39;</span>
                                       <span class="s1">&#39; LOTS of output. Not recommended &#39;</span>
                                       <span class="s1">&#39;unless you think something is going &#39;</span>
                                       <span class="s1">&#39;wrong)&#39;</span><span class="p">)</span>
        <span class="n">index_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n-jobs&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of threads to use when &#39;</span>
                                       <span class="s1">&#39;parallelizing exon finding and file &#39;</span>
                                       <span class="s1">&#39;reading. Default is -1, which means &#39;</span>
                                       <span class="s1">&#39;to use as many threads as are &#39;</span>
                                       <span class="s1">&#39;available.&#39;</span><span class="p">)</span>
        <span class="n">index_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--low-memory&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                                  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If set, then use a smaller memory &#39;</span>
                                       <span class="s1">&#39;footprint. By default, this is off.&#39;</span><span class="p">)</span>
        <span class="n">index_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--splice-types&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">default</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                                  <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                                  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Which splice types to find. By &#39;</span>
                                       <span class="s1">&#39;default, &quot;all&quot; are used which at this &#39;</span>
                                       <span class="s1">&#39;point is skipped exon (SE) and &#39;</span>
                                       <span class="s1">&#39;mutually exclusive exon (MXE) events. &#39;</span>
                                       <span class="s1">&#39;Can also specify only one, e.g. &quot;se&quot; &#39;</span>
                                       <span class="s1">&#39;or both &quot;se,mxe&quot;&#39;</span><span class="p">)</span>
        <span class="n">overwrite_parser</span> <span class="o">=</span> <span class="n">index_parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">overwrite_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--force&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If the &#39;outrigger index&#39; command &quot;</span>
                                           <span class="s2">&quot;was interrupted, there will be &quot;</span>
                                           <span class="s2">&quot;intermediate files remaining. If &quot;</span>
                                           <span class="s2">&quot;you wish to restart outrigger and &quot;</span>
                                           <span class="s2">&quot;overwrite them all, use this flag.&quot;</span>
                                           <span class="s2">&quot; If you want to continue from &quot;</span>
                                           <span class="s2">&quot;where you left off, use the &quot;</span>
                                           <span class="s2">&quot;&#39;--resume&#39; flag. If neither is &quot;</span>
                                           <span class="s2">&quot;specified, the program exits and &quot;</span>
                                           <span class="s2">&quot;complains to the user.&quot;</span><span class="p">)</span>
        <span class="n">overwrite_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--resume&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If the &#39;outrigger index&#39; command &quot;</span>
                                           <span class="s2">&quot;was interrupted, there will be &quot;</span>
                                           <span class="s2">&quot;intermediate files remaining. If &quot;</span>
                                           <span class="s2">&quot;you want to continue from &quot;</span>
                                           <span class="s2">&quot;where you left off, use this flag.&quot;</span>
                                           <span class="s2">&quot; The default action is to do &quot;</span>
                                           <span class="s2">&quot;nothing and ask the user for &quot;</span>
                                           <span class="s2">&quot;input.&quot;</span><span class="p">)</span>
        <span class="n">index_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># -- Subcommand to validate exons of built index --- #</span>
        <span class="n">validate_parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subparser</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
            <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ensure that the splicing events found all have &#39;</span>
                             <span class="s1">&#39;the correct splice sites&#39;</span><span class="p">)</span>
        <span class="n">validate_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--fasta&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Location of the genome fasta file &#39;</span>
                                          <span class="s1">&#39;for which to get the splice site &#39;</span>
                                          <span class="s1">&#39;sequences from&#39;</span><span class="p">)</span>
        <span class="n">validate_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">,</span> <span class="s1">&#39;--genome&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Either the genome name (e.g. &#39;</span>
                                          <span class="s1">&#39;&quot;mm10&quot; or &quot;hg19&quot;) or location of &#39;</span>
                                          <span class="s1">&#39;the genome chromosome &#39;</span>
                                          <span class="s1">&#39;sizes file for &quot;bedtools flank&quot; to &#39;</span>
                                          <span class="s1">&#39;make sure we do not accidentally &#39;</span>
                                          <span class="s1">&#39;ask for genome positions that are &#39;</span>
                                          <span class="s1">&#39;outside of the defined range&#39;</span><span class="p">)</span>
        <span class="n">validate_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--index&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of the folder where you saved &#39;</span>
                                          <span class="s1">&#39;the output from &quot;outrigger index&quot; &#39;</span>
                                          <span class="s1">&#39;(default is </span><span class="si">{}</span><span class="s1">, which is relative &#39;</span>
                                          <span class="s1">&#39;to the directory where you called &#39;</span>
                                          <span class="s1">&#39;this program, assuming you have &#39;</span>
                                          <span class="s1">&#39;called &quot;outrigger psi&quot; in the same &#39;</span>
                                          <span class="s1">&#39;folder as you called &quot;outrigger &#39;</span>
                                          <span class="s1">&#39;index&quot;).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDEX</span><span class="p">))</span>
        <span class="n">validate_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of the folder where you saved the output from &#39;</span>
                 <span class="s1">&#39;&quot;outrigger index&quot; (default is </span><span class="si">{}</span><span class="s1">, which is &#39;</span>
                 <span class="s1">&#39;relative to the directory where you called the program). &#39;</span>
                 <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">OUTPUT</span><span class="p">))</span>

        <span class="n">validate_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--valid-splice-sites&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">check_splice_sites</span><span class="o">.</span><span class="n">MAMMALIAN_SPLICE_SITES</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The intron-definition based splice sites that are allowed in&quot;</span>
                 <span class="s2">&quot; the data, which is in the format 5&#39;/3&#39; of the intron, and &quot;</span>
                 <span class="s2">&quot;separated by commas for different types. Default is </span><span class="si">{}</span><span class="s2">, &quot;</span>
                 <span class="s2">&quot;which are the major and minor spliceosome splice sites in &quot;</span>
                 <span class="s2">&quot;mammalian &quot;</span>
                 <span class="s2">&quot;systems.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_splice_sites</span><span class="o">.</span><span class="n">MAMMALIAN_SPLICE_SITES</span><span class="p">))</span>
        <span class="n">validate_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If given, print debugging logging &#39;</span>
                                          <span class="s1">&#39;information to standard out&#39;</span><span class="p">)</span>
        <span class="n">validate_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--low-memory&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If set, then use a smaller memory &#39;</span>
                                          <span class="s1">&#39;footprint. By default, this is &#39;</span>
                                          <span class="s1">&#39;off.&#39;</span><span class="p">)</span>
        <span class="n">validate_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">)</span>

        <span class="c1"># --- Subcommand to calculate psi on the built index --- #</span>
        <span class="n">psi_parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subparser</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
            <span class="s1">&#39;psi&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Calculate &quot;percent spliced-in&quot; (Psi) values using &#39;</span>
                        <span class="s1">&#39;the splicing event index built with &quot;outrigger &#39;</span>
                        <span class="s1">&#39;index&quot;&#39;</span><span class="p">)</span>
        <span class="n">psi_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--index&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of the folder where you saved the &#39;</span>
                                     <span class="s1">&#39;output from &quot;outrigger index&quot; (default &#39;</span>
                                     <span class="s1">&#39;is </span><span class="si">{}</span><span class="s1">, which is relative &#39;</span>
                                     <span class="s1">&#39;to the directory where you called this &#39;</span>
                                     <span class="s1">&#39;program, assuming you have called &#39;</span>
                                     <span class="s1">&#39;&quot;outrigger psi&quot; in the same folder as &#39;</span>
                                     <span class="s1">&#39;you called &quot;outrigger &#39;</span>
                                     <span class="s1">&#39;index&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDEX</span><span class="p">))</span>
        <span class="n">psi_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of the folder where you saved the output from &#39;</span>
                 <span class="s1">&#39;&quot;outrigger index&quot; (default is </span><span class="si">{}</span><span class="s1">, which is &#39;</span>
                 <span class="s1">&#39;relative to the directory where you called the program). &#39;</span>
                 <span class="s1">&#39;Cannot specify both an --index and --output with &quot;psi&quot;&#39;</span>
                 <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">OUTPUT</span><span class="p">))</span>
        <span class="n">psi_junctions</span> <span class="o">=</span> <span class="n">psi_parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">psi_junctions</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--junction-reads-csv&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of the compiled splice junction file to calculate psi &quot;</span>
                 <span class="s2">&quot;scores on. Default is the &#39;--output&#39; folder&#39;s &quot;</span>
                 <span class="s2">&quot;junctions/reads.csv file. Not required if you specify &quot;</span>
                 <span class="s2">&quot;SJ.out.tab files with &#39;--sj-out-tab&#39;&quot;</span><span class="p">)</span>
        <span class="n">psi_junctions</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-j&#39;</span><span class="p">,</span> <span class="s1">&#39;--sj-out-tab&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;SJ.out.tab files from STAR aligner output. Not required if &#39;</span>
                 <span class="s1">&#39;you specify a file with &quot;--compiled-junction-reads&quot;&#39;</span><span class="p">)</span>
        <span class="n">psi_junctions</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;--bam&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Bam files to use to calculate psi on&#39;</span><span class="p">)</span>
        <span class="n">psi_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;--min-reads&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minimum number of reads per junction for&#39;</span>
                                     <span class="s1">&#39; calculating Psi (default=10)&#39;</span><span class="p">)</span>
        <span class="n">psi_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="s1">&#39;--method&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;How to deal with multiple junctions on &#39;</span>
                                     <span class="s1">&#39;an event - take the mean (default) or &#39;</span>
                                     <span class="s1">&#39;the min? (the other option)&#39;</span><span class="p">)</span>
        <span class="n">psi_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;--uneven-coverage-multiplier&#39;</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If a junction one one side of an exon is&#39;</span>
                                     <span class="s1">&#39; bigger than the other side of the exon &#39;</span>
                                     <span class="s1">&#39;by this amount, (default is 10, so 10x &#39;</span>
                                     <span class="s1">&#39;bigger), then do not use this event&#39;</span><span class="p">)</span>
        <span class="n">psi_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ignore-multimapping&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Applies to STAR SJ.out.tab files only.&#39;</span>
                                     <span class="s1">&#39; If this flag is used, then do not &#39;</span>
                                     <span class="s1">&#39;include reads that mapped to multiple &#39;</span>
                                     <span class="s1">&#39;locations in the genome, not uniquely &#39;</span>
                                     <span class="s1">&#39;to a locus, in the read count for a &#39;</span>
                                     <span class="s1">&#39;junction. If inputting &quot;bam&quot; files, &#39;</span>
                                     <span class="s1">&#39;then this means that reads with a &#39;</span>
                                     <span class="s1">&#39;mapping quality (MAPQ) of less than &#39;</span>
                                     <span class="s1">&#39;255 are considered &quot;multimapped.&quot; This &#39;</span>
                                     <span class="s1">&#39;is the same thing as what the STAR &#39;</span>
                                     <span class="s1">&#39;aligner does. By default, this is off, &#39;</span>
                                     <span class="s1">&#39;and all reads are used.&#39;</span><span class="p">)</span>
        <span class="n">psi_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--reads-col&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;reads&#39;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of column in --splice-junction-csv &quot;</span>
                                     <span class="s2">&quot;containing reads to use. &quot;</span>
                                     <span class="s2">&quot;(default=&#39;reads&#39;)&quot;</span><span class="p">)</span>
        <span class="n">psi_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sample-id-col&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;sample_id&#39;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of column in --splice-junction-csv &quot;</span>
                                     <span class="s2">&quot;containing sample ids to use. &quot;</span>
                                     <span class="s2">&quot;(default=&#39;sample_id&#39;)&quot;</span><span class="p">)</span>
        <span class="n">psi_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--junction-id-col&#39;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="s1">&#39;junction_id&#39;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of column in --splice-junction-csv &quot;</span>
                                     <span class="s2">&quot;containing the ID of the junction to use&quot;</span>
                                     <span class="s2">&quot;. Must match exactly with the junctions &quot;</span>
                                     <span class="s2">&quot;in the index.&quot;</span>
                                     <span class="s2">&quot;(default=&#39;junction_id&#39;)&quot;</span><span class="p">)</span>
        <span class="n">psi_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If given, print debugging logging &#39;</span>
                                     <span class="s1">&#39;information to standard out&#39;</span><span class="p">)</span>
        <span class="n">psi_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n-jobs&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of threads to use when &#39;</span>
                                     <span class="s1">&#39;parallelizing psi calculation and file &#39;</span>
                                     <span class="s1">&#39;reading. Default is -1, which means &#39;</span>
                                     <span class="s1">&#39;to use as many threads as are &#39;</span>
                                     <span class="s1">&#39;available.&#39;</span><span class="p">)</span>
        <span class="n">psi_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--low-memory&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If set, then use a smaller memory &#39;</span>
                                     <span class="s1">&#39;footprint. By default, this is off.&#39;</span><span class="p">)</span>
        <span class="n">psi_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_options</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_options</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">print_usage</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">input_options</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">input_options</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">func</span><span class="p">()</span>

<div class="viewcode-block" id="CommandLine.index"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.CommandLine.index">[docs]</a>    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">Index</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
        <span class="n">index</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span></div>

<div class="viewcode-block" id="CommandLine.validate"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.CommandLine.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">validate</span> <span class="o">=</span> <span class="n">Validate</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
        <span class="n">validate</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span></div>

<div class="viewcode-block" id="CommandLine.psi"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.CommandLine.psi">[docs]</a>    <span class="k">def</span> <span class="nf">psi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">Psi</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
        <span class="n">psi</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span></div>

<div class="viewcode-block" id="CommandLine.do_usage_and_die"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.CommandLine.do_usage_and_die">[docs]</a>    <span class="k">def</span> <span class="nf">do_usage_and_die</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Cleanly exit if incorrect parameters are given</span>

<span class="sd">        If a critical error is encountered, where it is suspected that the</span>
<span class="sd">        program is not being called with consistent parameters or data, this</span>
<span class="sd">        method will write out an error string (str), then terminate execution</span>
<span class="sd">        of the program.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">print_usage</span><span class="p">()</span>
        <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PYTHONDEBUG&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
            <span class="c1"># If the PYTHONDEBUG shell environment variable exists, then</span>
            <span class="c1"># launch the python debugger</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">post_mortem</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">2</span></div></div>


<span class="c1"># Class: Usage</span>
<div class="viewcode-block" id="Usage"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Usage">[docs]</a><span class="k">class</span> <span class="nc">Usage</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Used to signal a Usage error, evoking a usage statement and eventual</span>
<span class="sd">    exit when raised</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span></div>


<div class="viewcode-block" id="Subcommand"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Subcommand">[docs]</a><span class="k">class</span> <span class="nc">Subcommand</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1"># output_folder = OUTPUT</span>
    <span class="n">sj_out_tab</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ignore_multimapping</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">min_reads</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">MIN_READS</span>
    <span class="n">reads_col</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">READS</span>
    <span class="n">gtf_filename</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gffutils_db</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">force</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">resume</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Read all arguments and set as attributes of this class</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maybe_make_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

<div class="viewcode-block" id="Subcommand.maybe_make_folder"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Subcommand.maybe_make_folder">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_make_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s2">&quot;Creating folder </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gtf_folder</span><span class="p">,</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">junctions_folder</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OUTPUT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gtf_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_folder</span><span class="p">,</span> <span class="s1">&#39;gtf&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">junctions_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span><span class="p">,</span> <span class="s1">&#39;junctions&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">junction_reads_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">junction_reads_csv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">junction_reads_csv</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">junctions_folder</span><span class="p">,</span> <span class="s1">&#39;reads.csv&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Subcommand.make_junction_reads_file"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Subcommand.make_junction_reads_file">[docs]</a>    <span class="k">def</span> <span class="nf">make_junction_reads_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span>
                <span class="s1">&#39;Reading SJ.out.files and creating a big splice junction&#39;</span>
                <span class="s1">&#39; table of reads spanning exon-exon junctions...&#39;</span><span class="p">)</span>
            <span class="n">splice_junctions</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">read_multiple_sj_out_tab</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sj_out_tab</span><span class="p">,</span>
                <span class="n">ignore_multimapping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_multimapping</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Reading bam files and creating a big splice &#39;</span>
                          <span class="s1">&#39;junction table of reads spanning exon-exon &#39;</span>
                          <span class="s1">&#39;junctions&#39;</span><span class="p">)</span>
            <span class="n">splice_junctions</span> <span class="o">=</span> <span class="n">bam</span><span class="o">.</span><span class="n">read_multiple_bams</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_multimapping</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">)</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">junction_reads_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">{}</span><span class="s1"> ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">junction_reads_filename</span><span class="p">))</span>
        <span class="n">splice_junctions</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">junction_reads_filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">splice_junctions</span></div>

<div class="viewcode-block" id="Subcommand.csv"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Subcommand.csv">[docs]</a>    <span class="k">def</span> <span class="nf">csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a csv file of compiled splice junctions&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">junction_reads_filename</span><span class="p">):</span>
            <span class="n">splice_junctions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_junction_reads_file</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Found compiled junction reads file in </span><span class="si">{}</span><span class="s1"> and &#39;</span>
                          <span class="s1">&#39;reading it in &#39;</span>
                          <span class="s1">&#39;...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">junction_reads_filename</span><span class="p">))</span>
            <span class="n">splice_junctions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">junction_reads_filename</span><span class="p">,</span>
                                           <span class="n">low_memory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">low_memory</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">splice_junctions</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Subcommand.junction_metadata"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Subcommand.junction_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">junction_metadata</span><span class="p">(</span><span class="n">spliced_reads</span><span class="p">,</span> <span class="n">csv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get just the junction info from the concatenated read files&quot;&quot;&quot;</span>
        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Creating splice junction metadata of merely where &#39;</span>
                      <span class="s1">&#39;junctions start and stop&#39;</span><span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">make_metadata</span><span class="p">(</span><span class="n">spliced_reads</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv</span><span class="p">):</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Writing metadata of junctions to </span><span class="si">{csv}</span><span class="s1">&#39;</span>
                          <span class="s1">&#39; ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="o">=</span><span class="n">csv</span><span class="p">))</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">metadata</span></div>

<div class="viewcode-block" id="Subcommand.filter_junctions_on_reads"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Subcommand.filter_junctions_on_reads">[docs]</a>    <span class="k">def</span> <span class="nf">filter_junctions_on_reads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spliced_reads</span><span class="p">):</span>
        <span class="c1"># Filter junction metadata to only get junctions with minimum reads</span>
        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Filtering for only junctions with minimum </span><span class="si">{}</span><span class="s1"> reads &#39;</span>
                      <span class="s1">&#39;...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_reads</span><span class="p">))</span>
        <span class="n">original</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spliced_reads</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">JUNCTION_ID</span><span class="p">))</span>
        <span class="n">enough_reads_rows</span> <span class="o">=</span> <span class="n">spliced_reads</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reads_col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_reads</span>
        <span class="n">spliced_reads</span> <span class="o">=</span> <span class="n">spliced_reads</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">enough_reads_rows</span><span class="p">]</span>
        <span class="n">enough_reads</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spliced_reads</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">JUNCTION_ID</span><span class="p">))</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">original</span> <span class="o">-</span> <span class="n">enough_reads</span>
        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{enough}</span><span class="s1">/</span><span class="si">{original}</span><span class="s1"> junctions remain after &#39;</span>
                      <span class="s1">&#39;filtering out </span><span class="si">{filtered}</span><span class="s1"> junctions with &lt; &#39;</span>
                      <span class="s1">&#39;</span><span class="si">{min_reads}</span><span class="s1"> &#39;</span>
                      <span class="s1">&#39;reads.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filtered</span><span class="o">=</span><span class="n">filtered</span><span class="p">,</span> <span class="n">enough</span><span class="o">=</span><span class="n">enough_reads</span><span class="p">,</span>
                                      <span class="n">original</span><span class="o">=</span><span class="n">original</span><span class="p">,</span>
                                      <span class="n">min_reads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_reads</span><span class="p">))</span>
        <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spliced_reads</span></div>

<div class="viewcode-block" id="Subcommand.maybe_make_db"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Subcommand.maybe_make_db">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_make_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get GFFutils database from file or create from a gtf&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gffutils_db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">copied_db</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gtf_folder</span><span class="p">,</span>
                                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gffutils_db</span><span class="p">))</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Copying gffutils database from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1"> &#39;</span>
                          <span class="s1">&#39;...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gffutils_db</span><span class="p">,</span> <span class="n">copied_db</span><span class="p">))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gffutils_db</span><span class="p">,</span> <span class="n">copied_db</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Reading gffutils database from </span><span class="si">{}</span><span class="s1"> ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">copied_db</span><span class="p">))</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">gffutils</span><span class="o">.</span><span class="n">FeatureDB</span><span class="p">(</span><span class="n">copied_db</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gtf_filename</span><span class="p">)</span>
            <span class="n">db_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gtf_folder</span><span class="p">,</span>
                                       <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.db&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basename</span><span class="p">))</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s2">&quot;Found GTF file in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gtf_filename</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">gffutils</span><span class="o">.</span><span class="n">FeatureDB</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span>
                <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span>
                    <span class="s2">&quot;Found existing built outrigger-built gffutils database &quot;</span>
                    <span class="s2">&quot;file in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db_filename</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span>
                    <span class="s1">&#39;Creating a &quot;gffutils&quot; &#39;</span>
                    <span class="s1">&#39;database </span><span class="si">{}</span><span class="s1"> ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db_filename</span><span class="p">))</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">gtf</span><span class="o">.</span><span class="n">create_db</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gtf_filename</span><span class="p">,</span> <span class="n">db_filename</span><span class="p">)</span>
                <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">db</span></div>

<div class="viewcode-block" id="Subcommand.maybe_overwrite"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Subcommand.maybe_overwrite">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_overwrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensures that filename is not overwritten unless user-specified</span>

<span class="sd">        - If the file doesn&#39;t exist, return &quot;True&quot;, as in &quot;yes, please</span>
<span class="sd">          overwrite&quot; even though there wasn&#39;t really a file there, but the</span>
<span class="sd">          action is still to create the file in the next step</span>
<span class="sd">        - If the file exists and the user specified nothing, exit the program</span>
<span class="sd">          and complain that either --force or --resume must be specified</span>
<span class="sd">        - If the file exists and the user specified --force, then return True</span>
<span class="sd">        - If the file exists and the user specified --resume, then return False</span>
<span class="sd">          so that the file is not overwritten</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Path to a file that you may want to overwrite</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        if_overwrite : bool</span>
<span class="sd">            If True, then the next step in the program has the go-ahead to</span>
<span class="sd">            &quot;overwrite&quot; or create the file. If False, the file exists and the</span>
<span class="sd">            user doesn&#39;t want to overwrite it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
                <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s2">&quot;Found existing </span><span class="si">{filename}</span><span class="s2">, overwriting with &quot;</span>
                              <span class="s2">&quot;--force flag&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume</span><span class="p">:</span>
                <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span>
                    <span class="s2">&quot;With the flag &#39;--resume&#39;, Found an existing file &quot;</span>
                    <span class="s2">&quot;containing novel exons,&quot;</span>
                    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">, not re-calculating. To force overwriting, &quot;</span>
                    <span class="s2">&quot;use the flag &#39;&#39;--force&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found existing </span><span class="si">{filename}</span><span class="s2"> &quot;</span>
                             <span class="s2">&quot;but don&#39;t &quot;</span>
                             <span class="s2">&quot;know whether you want me to continue where I &quot;</span>
                             <span class="s2">&quot;stopped (&#39;--resume&#39;) or force overwrite &quot;</span>
                             <span class="s2">&quot;and restart from &quot;</span>
                             <span class="s2">&quot;scratch (&#39;--force&#39;)! Exiting.&quot;</span>
                             <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="Index"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Index">[docs]</a><span class="k">class</span> <span class="nc">Index</span><span class="p">(</span><span class="n">Subcommand</span><span class="p">):</span>

    <span class="n">max_de_novo_exon_length</span> <span class="o">=</span> <span class="n">outrigger</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">MAX_DE_NOVO_EXON_LENGTH</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">splice_abbrevs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splice_types</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">SPLICE_ABBREVS</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">splice_types</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Index.make_exon_junction_adjacencies"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Index.make_exon_junction_adjacencies">[docs]</a>    <span class="k">def</span> <span class="nf">make_exon_junction_adjacencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get annotated exon_cols next to junctions in data&quot;&quot;&quot;</span>
        <span class="n">exon_junction_adjacencies</span> <span class="o">=</span> <span class="n">adjacencies</span><span class="o">.</span><span class="n">ExonJunctionAdjacencies</span><span class="p">(</span>
            <span class="n">metadata</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">max_de_novo_exon_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_de_novo_exon_length</span><span class="p">)</span>

        <span class="n">novel_exons_gtf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gtf_folder</span><span class="p">,</span> <span class="s1">&#39;novel_exons.gtf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_overwrite</span><span class="p">(</span><span class="n">novel_exons_gtf</span><span class="p">):</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Detecting de novo exons based on gaps between &#39;</span>
                          <span class="s1">&#39;junctions ...&#39;</span><span class="p">)</span>
            <span class="n">exon_junction_adjacencies</span><span class="o">.</span><span class="n">detect_exons_from_junctions</span><span class="p">()</span>
            <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="n">novel_exons_gtf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gtf_folder</span><span class="p">,</span> <span class="s1">&#39;novel_exons.gtf&#39;</span><span class="p">)</span>
        <span class="n">novel_exons</span> <span class="o">=</span> <span class="n">exon_junction_adjacencies</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">features_of_type</span><span class="p">(</span>
            <span class="n">outrigger</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">NOVEL_EXON</span><span class="p">)</span>
        <span class="n">n_novel_exons</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">novel_exons</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">{n}</span><span class="s1"> novel exons to </span><span class="si">{gtf}</span><span class="s1"> ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="n">n_novel_exons</span><span class="p">,</span> <span class="n">gtf</span><span class="o">=</span><span class="n">novel_exons_gtf</span><span class="p">))</span>
        <span class="n">exon_junction_adjacencies</span><span class="o">.</span><span class="n">write_de_novo_exons</span><span class="p">(</span><span class="n">novel_exons_gtf</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="n">csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_folder</span><span class="p">,</span>
                           <span class="s1">&#39;exon_direction_junction.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Getting junction-direction-exon triples for graph &#39;</span>
                          <span class="s1">&#39;database ...&#39;</span><span class="p">)</span>
            <span class="n">junction_exon_triples</span> <span class="o">=</span> \
                <span class="n">exon_junction_adjacencies</span><span class="o">.</span><span class="n">upstream_downstream_exons</span><span class="p">()</span>
            <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Writing junction-exon-direction triples&#39;</span>
                          <span class="s1">&#39; to </span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">))</span>
            <span class="n">junction_exon_triples</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume</span><span class="p">:</span>
            <span class="n">junction_exon_triples</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv</span><span class="p">,</span>
                                                <span class="n">low_memory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">low_memory</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found existing junction-exon-triples file &quot;</span>
                             <span class="s2">&quot;(</span><span class="si">{csv}</span><span class="s2">) but don&#39;t &quot;</span>
                             <span class="s2">&quot;know whether you want me to continue where I &quot;</span>
                             <span class="s2">&quot;stopped (&#39;--resume&#39;) or force restart from &quot;</span>
                             <span class="s2">&quot;scratch (&#39;--force&#39;)! Exiting.&quot;</span>
                             <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="o">=</span><span class="n">csv</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">junction_exon_triples</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Index.make_graph"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Index.make_graph">[docs]</a>    <span class="k">def</span> <span class="nf">make_graph</span><span class="p">(</span><span class="n">junction_exon_triples</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create graph database of exon-junction adjacencies&quot;&quot;&quot;</span>
        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Populating graph database of the &#39;</span>
                      <span class="s1">&#39;junction-direction-exon triples ...&#39;</span><span class="p">)</span>

        <span class="n">event_maker</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">EventMaker</span><span class="p">(</span><span class="n">junction_exon_triples</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">event_maker</span></div>

    <span class="k">def</span> <span class="nf">_exists_event_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_folder</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">,</span> <span class="n">EVENTS_CSV</span><span class="p">))</span>

<div class="viewcode-block" id="Index.make_events_by_traversing_graph"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Index.make_events_by_traversing_graph">[docs]</a>    <span class="k">def</span> <span class="nf">make_events_by_traversing_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_maker</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Search the splice graph for alternative exons&quot;&quot;&quot;</span>
        <span class="n">existing_events</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_exists_event_csv</span><span class="p">(</span><span class="n">splice_abbrev</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">splice_abbrev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">splice_abbrevs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">existing_events</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Found existing splicing events files for all splice&#39;</span>
                          <span class="s1">&#39; types, so not searching. To force&#39;</span>
                          <span class="s1">&#39; re-finding these splicing events, use the flag&#39;</span>
                          <span class="s1">&#39; &quot;--force&quot;.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">undiscovered_splice_types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">splice_abbrev</span> <span class="k">for</span> <span class="n">splice_abbrev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">splice_abbrevs</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exists_event_csv</span><span class="p">(</span><span class="n">splice_abbrev</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">]</span>

        <span class="n">event_dfs</span> <span class="o">=</span> <span class="n">event_maker</span><span class="o">.</span><span class="n">find_events</span><span class="p">(</span>
            <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">splice_types</span><span class="o">=</span><span class="n">undiscovered_splice_types</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">splice_abbrev</span><span class="p">,</span> <span class="n">event_df</span> <span class="ow">in</span> <span class="n">event_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_folder</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                               <span class="n">EVENTS_CSV</span><span class="p">)</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">csv</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>

            <span class="n">n_events</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">event_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">n_events</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span>
                    <span class="s1">&#39;Found </span><span class="si">{n}</span><span class="s1"> </span><span class="si">{abbrev}</span><span class="s1"> events.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">n</span><span class="o">=</span><span class="n">n_events</span><span class="p">,</span> <span class="n">abbrev</span><span class="o">=</span><span class="n">splice_abbrev</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">csv</span><span class="o">=</span><span class="n">csv</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_event_attributes</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">event_df</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span>
                    <span class="s1">&#39;No </span><span class="si">{abbrev}</span><span class="s1"> events found in the junction and exon &#39;</span>
                    <span class="s1">&#39;data.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">abbrev</span><span class="o">=</span><span class="n">splice_abbrev</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span></div>

<div class="viewcode-block" id="Index.get_event_attributes"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Index.get_event_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">get_event_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">event_df</span><span class="p">,</span> <span class="n">splice_type</span><span class="p">):</span>
        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span>
            <span class="s1">&#39;Making metadata file of </span><span class="si">{splice_type}</span><span class="s1"> events, &#39;</span>
            <span class="s1">&#39;annotating them with GTF attributes ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">splice_type</span><span class="o">=</span><span class="n">splice_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>

        <span class="n">sa</span> <span class="o">=</span> <span class="n">gtf</span><span class="o">.</span><span class="n">SplicingAnnotator</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">event_df</span><span class="p">,</span> <span class="n">splice_type</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Making &quot;.bed&quot; files for exons in each event ...&#39;</span><span class="p">)</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_folder</span><span class="p">,</span> <span class="n">splice_type</span><span class="p">)</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">exon_bedfiles</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="n">attributes</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">attributes</span><span class="p">()</span>
        <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="c1"># Write to a file</span>
        <span class="n">csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_folder</span><span class="p">,</span> <span class="n">splice_type</span><span class="p">,</span> <span class="n">EVENTS_CSV</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">{splice_type}</span><span class="s1"> events to </span><span class="si">{csv}</span><span class="s1"> &#39;</span>
                      <span class="s1">&#39;...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">splice_type</span><span class="o">=</span><span class="n">splice_type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">csv</span><span class="o">=</span><span class="n">csv</span><span class="p">))</span>
        <span class="n">attributes</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">index_label</span><span class="o">=</span><span class="n">outrigger</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">EVENT_ID</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span></div>

<div class="viewcode-block" id="Index.write_new_gtf"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Index.write_new_gtf">[docs]</a>    <span class="k">def</span> <span class="nf">write_new_gtf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="n">gtf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gtf_folder</span><span class="p">,</span>
                           <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gtf_filename</span><span class="p">))</span>
        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Write new GTF to </span><span class="si">{}</span><span class="s1"> ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gtf</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gtf</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">all_features</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="n">common</span><span class="o">.</span><span class="n">ORDER_BY</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span></div>

<div class="viewcode-block" id="Index.execute"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Index.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Must output the junction exon triples</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;outrigger.index&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">spliced_reads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv</span><span class="p">()</span>

        <span class="n">spliced_reads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_junctions_on_reads</span><span class="p">(</span><span class="n">spliced_reads</span><span class="p">)</span>
        <span class="n">metadata_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">junctions_folder</span><span class="p">,</span> <span class="n">METADATA_CSV</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">junction_metadata</span><span class="p">(</span><span class="n">spliced_reads</span><span class="p">,</span> <span class="n">metadata_csv</span><span class="p">)</span>

        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_make_db</span><span class="p">()</span>

        <span class="n">junction_exon_triples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_exon_junction_adjacencies</span><span class="p">(</span>
            <span class="n">metadata</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

        <span class="n">event_maker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_graph</span><span class="p">(</span><span class="n">junction_exon_triples</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_events_by_traversing_graph</span><span class="p">(</span><span class="n">event_maker</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_new_gtf</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SubcommandAfterIndex"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.SubcommandAfterIndex">[docs]</a><span class="k">class</span> <span class="nc">SubcommandAfterIndex</span><span class="p">(</span><span class="n">Subcommand</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Can use different index folder than outrigger_output/index&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Where to read the index from&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_folder</span><span class="p">,</span>\
               <span class="bp">self</span><span class="o">.</span><span class="n">gtf_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">junctions_folder</span></div>


<div class="viewcode-block" id="Validate"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Validate">[docs]</a><span class="k">class</span> <span class="nc">Validate</span><span class="p">(</span><span class="n">SubcommandAfterIndex</span><span class="p">):</span>

<div class="viewcode-block" id="Validate.exon_pair_splice_sites"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Validate.exon_pair_splice_sites">[docs]</a>    <span class="k">def</span> <span class="nf">exon_pair_splice_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exonA</span><span class="p">,</span> <span class="n">exonB</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{exonA}</span><span class="s1">-</span><span class="si">{exonB}</span><span class="s1">_splice_site&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">exonA</span><span class="o">=</span><span class="n">exonA</span><span class="p">,</span> <span class="n">exonB</span><span class="o">=</span><span class="n">exonB</span><span class="p">)</span>

        <span class="n">exonA_splice_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">individual_exon_splice_sites</span><span class="p">(</span>
            <span class="n">exonA</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">,</span> <span class="s1">&#39;downstream&#39;</span><span class="p">)</span>
        <span class="n">exonB_splice_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">individual_exon_splice_sites</span><span class="p">(</span>
            <span class="n">exonB</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">,</span> <span class="s1">&#39;upstream&#39;</span><span class="p">)</span>

        <span class="n">intron_splice_site</span> <span class="o">=</span> <span class="n">exonA_splice_sites</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> \
            <span class="o">+</span> <span class="n">exonB_splice_sites</span>
        <span class="n">intron_splice_site</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">return</span> <span class="n">intron_splice_site</span></div>

<div class="viewcode-block" id="Validate.individual_exon_splice_sites"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Validate.individual_exon_splice_sites">[docs]</a>    <span class="k">def</span> <span class="nf">individual_exon_splice_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exon</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="n">exon_bed</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_index</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">,</span>
                                <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.bed&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exon</span><span class="p">))</span>
        <span class="n">splice_sites</span> <span class="o">=</span> <span class="n">check_splice_sites</span><span class="o">.</span><span class="n">read_splice_sites</span><span class="p">(</span>
            <span class="n">exon_bed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">genome</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fasta</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">splice_sites</span></div>

<div class="viewcode-block" id="Validate.execute"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Validate.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">valid_splice_sites</span> <span class="o">=</span> <span class="n">check_splice_sites</span><span class="o">.</span><span class="n">splice_site_str_to_tuple</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_splice_sites</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">splice_name</span><span class="p">,</span> <span class="n">splice_abbrev</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">SPLICE_TYPES</span><span class="p">:</span>
            <span class="n">splice_name_spaces</span> <span class="o">=</span> <span class="n">splice_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Finding valid splice sites in </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">) &#39;</span>
                          <span class="s1">&#39;splice type ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">splice_name_spaces</span><span class="p">,</span>
                                                   <span class="n">splice_abbrev</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
            <span class="n">isoform_exons</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">SPLICE_TYPE_ISOFORM_EXONS</span><span class="p">[</span><span class="n">splice_abbrev</span><span class="p">]</span>

            <span class="n">validated_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_folder</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">,</span>
                                            <span class="s1">&#39;validated&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maybe_make_folder</span><span class="p">(</span><span class="n">validated_folder</span><span class="p">)</span>

            <span class="n">splice_sites_seriess</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">isoform</span><span class="p">,</span> <span class="n">exons</span> <span class="ow">in</span> <span class="n">isoform_exons</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">valid_str</span> <span class="o">=</span> <span class="s1">&#39; or &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_splice_sites</span><span class="p">)</span>
                <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Finding valid splice sites for </span><span class="si">{isoform}</span><span class="s1"> of&#39;</span>
                              <span class="s1">&#39; </span><span class="si">{splice_name}</span><span class="s1"> events which match &#39;</span>
                              <span class="s1">&#39;</span><span class="si">{valid_splice_sites}</span><span class="s1">&#39;</span>
                              <span class="s1">&#39;...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isoform</span><span class="o">=</span><span class="n">isoform</span><span class="p">,</span>
                                           <span class="n">splice_name</span><span class="o">=</span><span class="n">splice_name_spaces</span><span class="p">,</span>
                                           <span class="n">valid_splice_sites</span><span class="o">=</span><span class="n">valid_str</span><span class="p">))</span>
                <span class="n">exon_pairs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">exons</span><span class="p">,</span> <span class="n">exons</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">for</span> <span class="n">exonA</span><span class="p">,</span> <span class="n">exonB</span> <span class="ow">in</span> <span class="n">exon_pairs</span><span class="p">:</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Finding splice sites for </span><span class="si">{exonA}</span><span class="s1"> and &#39;</span>
                                  <span class="s1">&#39;</span><span class="si">{exonB}</span><span class="s1"> ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exonA</span><span class="o">=</span><span class="n">exonA</span><span class="p">,</span>
                                                       <span class="n">exonB</span><span class="o">=</span><span class="n">exonB</span><span class="p">))</span>
                    <span class="n">intron_splice_site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exon_pair_splice_sites</span><span class="p">(</span>
                        <span class="n">exonA</span><span class="p">,</span> <span class="n">exonB</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">)</span>
                    <span class="n">splice_sites_seriess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intron_splice_site</span><span class="p">)</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">splice_sites</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">splice_sites_seriess</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_folder</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">,</span>
                               <span class="s1">&#39;splice_sites.csv&#39;</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Writing splice sites to </span><span class="si">{csv}</span><span class="s1"> ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">csv</span><span class="o">=</span><span class="n">csv</span><span class="p">))</span>
            <span class="n">splice_sites</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">n_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">splice_sites</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">splice_sites_is_valid</span> <span class="o">=</span> <span class="n">splice_sites</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">valid_splice_sites</span><span class="p">)</span>
            <span class="n">valid_events_rows</span> <span class="o">=</span> <span class="n">splice_sites_is_valid</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">splice_sites_validated</span> <span class="o">=</span> <span class="n">splice_sites</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_events_rows</span><span class="p">]</span>
            <span class="n">n_valid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">splice_sites_validated</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Validated </span><span class="si">{valid}</span><span class="s2">/</span><span class="si">{total}</span><span class="s2"> </span><span class="si">{splice_name}</span><span class="s2"> &quot;</span>
                          <span class="s2">&quot;(</span><span class="si">{splice_abbrev}</span><span class="s2">) events. &quot;</span>
                          <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">valid</span><span class="o">=</span><span class="n">n_valid</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">n_total</span><span class="p">,</span>
                                    <span class="n">splice_name</span><span class="o">=</span><span class="n">splice_name_spaces</span><span class="p">,</span>
                                    <span class="n">splice_abbrev</span><span class="o">=</span><span class="n">splice_abbrev</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>

            <span class="n">original_events_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_index</span><span class="p">,</span>
                                               <span class="n">splice_abbrev</span><span class="p">,</span> <span class="n">EVENTS_CSV</span><span class="p">)</span>
            <span class="n">validated_events_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">validated_folder</span><span class="p">,</span> <span class="n">EVENTS_CSV</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Writing validated events to </span><span class="si">{csv}</span><span class="s1"> ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">csv</span><span class="o">=</span><span class="n">validated_events_csv</span><span class="p">))</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">validated_events_csv</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_validated</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">original_events_csv</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_original</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f_original</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">f_validated</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">splice_sites_validated</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                            <span class="n">f_validated</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Psi"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Psi">[docs]</a><span class="k">class</span> <span class="nc">Psi</span><span class="p">(</span><span class="n">SubcommandAfterIndex</span><span class="p">):</span>

    <span class="c1"># Instantiate empty variables here so PyCharm doesn&#39;t get mad at me</span>
    <span class="n">reads_col</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sample_id_col</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">junction_id_col</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">required_cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;--reads-col&#39;</span><span class="p">:</span> <span class="n">reads_col</span><span class="p">,</span>
                     <span class="s1">&#39;--sample-id-col&#39;</span><span class="p">:</span> <span class="n">sample_id_col</span><span class="p">,</span>
                     <span class="s1">&#39;--junction-id-col&#39;</span><span class="p">:</span> <span class="n">junction_id_col</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">psi_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span><span class="p">,</span> <span class="s1">&#39;psi&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">splice_type_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">splice_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_index</span><span class="p">,</span>
                                               <span class="n">splice_abbrev</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">splice_name</span><span class="p">,</span> <span class="n">splice_abbrev</span> <span class="ow">in</span>
                    <span class="n">outrigger</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">SPLICE_TYPES</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_folder</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Read all arguments and set as attributes of this class</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_index</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;The index folder (</span><span class="si">{}</span><span class="s2">) doesn&#39;t exist! Cowardly &quot;</span>
                          <span class="s2">&quot;exiting because I don&#39;t know what events to &quot;</span>
                          <span class="s2">&quot;calcaulate psi on :(&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_index</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">splice_name</span><span class="p">,</span> <span class="n">splice_folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">splice_type_folders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">splice_folder</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                    <span class="s2">&quot;The splicing index of </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">) splice types &quot;</span>
                    <span class="s2">&quot;doesn&#39;t exist! Cowardly exiting because I &quot;</span>
                    <span class="s2">&quot;don&#39;t know how to define events :(&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">splice_name</span><span class="p">,</span> <span class="n">splice_folder</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">junction_reads_filename</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">bam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                <span class="s2">&quot;The junction reads csv file (</span><span class="si">{}</span><span class="s2">) doesn&#39;t exist! &quot;</span>
                <span class="s2">&quot;Cowardly exiting because I don&#39;t have the junction &quot;</span>
                <span class="s2">&quot;counts calcaulate psi on :(&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">junction_reads_filename</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maybe_make_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

<div class="viewcode-block" id="Psi.maybe_read_junction_reads"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Psi.maybe_read_junction_reads">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_read_junction_reads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reads_col</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">}</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span>
                <span class="s1">&#39;Reading splice junction reads from </span><span class="si">{}</span><span class="s1"> ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">junction_reads_filename</span><span class="p">))</span>
            <span class="n">junction_reads</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">junction_reads_filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                <span class="n">low_memory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">low_memory</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                <span class="s2">&quot;There is no junction reads file at the expected location&quot;</span>
                <span class="s2">&quot; (</span><span class="si">{csv}</span><span class="s2">). Are you in the correct directory?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">csv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">junction_reads_filename</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">junction_reads</span></div>

<div class="viewcode-block" id="Psi.validate_junction_reads_data"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Psi.validate_junction_reads_data">[docs]</a>    <span class="k">def</span> <span class="nf">validate_junction_reads_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">junction_reads</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">flag</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">junction_reads</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The required column name </span><span class="si">{col}</span><span class="s2"> does not exist in </span><span class="si">{csv}</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;You can change this with the command line flag, &quot;</span>
                    <span class="s2">&quot;</span><span class="si">{flag}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">csv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">junction_reads_filename</span><span class="p">,</span>
                                    <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="p">))</span></div>

<div class="viewcode-block" id="Psi.maybe_get_validated_events"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Psi.maybe_get_validated_events">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_get_validated_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">):</span>
        <span class="n">splice_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_index</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">)</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splice_folder</span><span class="p">,</span> <span class="n">EVENTS_CSV</span><span class="p">)</span>
        <span class="n">validated_events</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splice_folder</span><span class="p">,</span> <span class="s1">&#39;validated&#39;</span><span class="p">,</span> <span class="n">EVENTS_CSV</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">validated_events</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">validated_events</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">events</span></div>

<div class="viewcode-block" id="Psi.execute"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.Psi.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate percent spliced in (psi) of splicing events&quot;&quot;&quot;</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;outrigger.psi&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">junction_reads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv</span><span class="p">()</span>

        <span class="n">metadata_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">junctions_folder</span><span class="p">,</span> <span class="n">METADATA_CSV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">junction_metadata</span><span class="p">(</span><span class="n">junction_reads</span><span class="p">,</span> <span class="n">metadata_csv</span><span class="p">)</span>

        <span class="n">junction_reads_2d</span> <span class="o">=</span> <span class="n">junction_reads</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_id_col</span><span class="p">,</span>
                                                 <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">junction_id_col</span><span class="p">,</span>
                                                 <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reads_col</span><span class="p">)</span>
        <span class="n">junction_reads_2d</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">junction_reads_2d</span> <span class="o">=</span> <span class="n">junction_reads_2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- Splice Junction reads ---&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">junction_reads</span><span class="o">.</span><span class="n">head</span><span class="p">()))</span>

        <span class="n">psis</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">summaries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">splice_name</span><span class="p">,</span> <span class="n">splice_abbrev</span> <span class="ow">in</span> <span class="n">outrigger</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">SPLICE_TYPES</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_get_validated_events</span><span class="p">(</span><span class="n">splice_abbrev</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">{name}</span><span class="s1"> (</span><span class="si">{abbrev}</span><span class="s1">) events found, &#39;</span>
                              <span class="s1">&#39;skipping.&#39;</span><span class="o">.</span> <span class="nb">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">splice_name</span><span class="p">,</span>
                                                  <span class="n">abbrev</span><span class="o">=</span><span class="n">splice_abbrev</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="c1"># event_type = os.path.basename(filename).split(&#39;.csv&#39;)[0]</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Reading </span><span class="si">{name}</span><span class="s1"> (</span><span class="si">{abbrev}</span><span class="s1">) events from </span><span class="si">{filename}</span><span class="s1">&#39;</span>
                          <span class="s1">&#39; ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">splice_name</span><span class="p">,</span> <span class="n">abbrev</span><span class="o">=</span><span class="n">splice_abbrev</span><span class="p">,</span>
                                        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">))</span>

            <span class="n">event_annotation</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                           <span class="n">low_memory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">low_memory</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

            <span class="n">isoform_junctions</span> <span class="o">=</span> <span class="n">outrigger</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">ISOFORM_JUNCTIONS</span><span class="p">[</span>
                <span class="n">splice_abbrev</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- Splicing event annotation ---&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">event_annotation</span><span class="o">.</span><span class="n">head</span><span class="p">()))</span>

            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span>
                <span class="s1">&#39;Calculating percent spliced-in (Psi) scores on &#39;</span>
                <span class="s1">&#39;</span><span class="si">{name}</span><span class="s1"> (</span><span class="si">{abbrev}</span><span class="s1">) events ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">splice_name</span><span class="p">,</span> <span class="n">abbrev</span><span class="o">=</span><span class="n">splice_abbrev</span><span class="p">))</span>
            <span class="c1"># Splice type percent spliced-in (psi) and summary</span>
            <span class="n">type_psi</span><span class="p">,</span> <span class="n">summary</span> <span class="o">=</span> <span class="n">compute</span><span class="o">.</span><span class="n">calculate_psi</span><span class="p">(</span>
                <span class="n">event_annotation</span><span class="p">,</span> <span class="n">junction_reads_2d</span><span class="p">,</span>
                <span class="n">min_reads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_reads</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">uneven_coverage_multiplier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uneven_coverage_multiplier</span><span class="p">,</span>
                <span class="o">**</span><span class="n">isoform_junctions</span><span class="p">)</span>

            <span class="c1"># Write this event&#39;s percent spliced-in matrix</span>
            <span class="n">csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_folder</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">,</span>
                               <span class="s1">&#39;psi.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">splice_abbrev</span><span class="p">))</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">{name}</span><span class="s1"> (</span><span class="si">{abbrev}</span><span class="s1">) Psi values to </span><span class="si">{filename}</span><span class="s1">&#39;</span>
                          <span class="s1">&#39; ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">splice_name</span><span class="p">,</span> <span class="n">abbrev</span><span class="o">=</span><span class="n">splice_abbrev</span><span class="p">,</span>
                                        <span class="n">filename</span><span class="o">=</span><span class="n">csv</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maybe_make_folder</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">csv</span><span class="p">))</span>
            <span class="n">type_psi</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="s1">&#39;NA&#39;</span><span class="p">)</span>

            <span class="c1"># Write this event&#39;s summary of events and why they weren&#39;t or were</span>
            <span class="c1"># calculated Psi on</span>
            <span class="n">csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_folder</span><span class="p">,</span> <span class="n">splice_abbrev</span><span class="p">,</span>
                               <span class="s1">&#39;summary.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">splice_abbrev</span><span class="p">))</span>
            <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">{name}</span><span class="s1"> (</span><span class="si">{abbrev}</span><span class="s1">) event summaries (e.g. &#39;</span>
                          <span class="s1">&#39;number of reads, why an event does not have a Psi &#39;</span>
                          <span class="s1">&#39;score) to </span><span class="si">{filename}</span><span class="s1"> ...&#39;</span>
                          <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">splice_name</span><span class="p">,</span> <span class="n">abbrev</span><span class="o">=</span><span class="n">splice_abbrev</span><span class="p">,</span>
                                    <span class="n">filename</span><span class="o">=</span><span class="n">csv</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maybe_make_folder</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">csv</span><span class="p">))</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="s1">&#39;NA&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">psis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_psi</span><span class="p">)</span>
            <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;splice_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">splice_abbrev</span>
            <span class="n">summaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Concatenating all calculated psi scores &#39;</span>
                      <span class="s1">&#39;into one big matrix...&#39;</span><span class="p">)</span>
        <span class="n">splicing</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">psis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="n">splicing</span> <span class="o">=</span> <span class="n">splicing</span><span class="o">.</span><span class="n">T</span>
        <span class="n">csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_folder</span><span class="p">,</span> <span class="s1">&#39;outrigger_psi.csv&#39;</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Writing a samples x features matrix of Psi &#39;</span>
                      <span class="s1">&#39;scores to </span><span class="si">{}</span><span class="s1"> ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">))</span>
        <span class="n">splicing</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="s1">&#39;NA&#39;</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Concatenating all summaries &#39;</span>
                      <span class="s1">&#39;into one big matrix...&#39;</span><span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">summaries</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="n">csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_folder</span><span class="p">,</span> <span class="s1">&#39;outrigger_summary.csv&#39;</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s1">&#39;Writing summary table of Psi scores, junction reads, &#39;</span>
                      <span class="s1">&#39;and cases to </span><span class="si">{}</span><span class="s1"> ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv</span><span class="p">))</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="s1">&#39;NA&#39;</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">done</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../outrigger.commandline.html#outrigger.commandline.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">CommandLine</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">except</span> <span class="n">Usage</span><span class="p">:</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">do_usage_and_die</span><span class="p">()</span></div>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Outrigger</a></h1>


<a href="../../index.html">
<img src="../../_static/logo-1x.png" width=80%>
</a>

<h3><a href="../../index.html">Table Of Contents</a></h3>

<ul>
  <li><a href="../../index.html">Home</a></li>
  <li><a href="../../contents.html">Contents</a></li>
  <li><a href="../../installation.html">Install</a></li>
  <li><a href="../../Usage.html">Usage</a></li>
  <li><a href="../../subcommands/outrigger_index.html"><code>index</code>: Detect exons</a></li>
  <li><a href="../../subcommands/outrigger_validate.html"><code>validate</code>: Remove non-canonical splice sites</a></li>
  <li><a href="../../subcommands/outrigger_psi.html"><code>psi</code>: Quantify exon inclusion</a></li>
  <li><a href="../../history.html">Changelog</a></li>
  <li><a href="../../license.html">License</a></li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015-2017, Olga Botvinnik.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.8</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>